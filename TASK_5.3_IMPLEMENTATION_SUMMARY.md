# Task 5.3 実装サマリー: タスク分解API

## 実装日
2026年2月7日

## 概要
Task 5.3「タスク分解APIを実装」を完了しました。抽象的なタスクを3-5個の具体的なサブタスクに分解するAPIエンドポイントを実装し、Azure OpenAIとの連携を実現しました。

## 実装内容

### 1. タスク分解ロジックの実装
**ファイル**: `app/services/task_service.py`

#### 実装した機能:
- `decompose_task()` メソッドの実装
- Azure OpenAI GPT-4oを使用したタスク分解
- 3-5個のサブタスク生成（要件5.1に準拠）
- 論理的な実行順序の保証（要件5.2に準拠）
- サブタスクの順序付け（1から始まる連番）

#### プロンプト設計:
```python
system_prompt = """あなたはプロジェクト管理の専門家です。
抽象的なタスクを具体的な実行ステップに分解してください。

ルール:
1. サブタスクは3個から5個の範囲で生成してください
2. サブタスクは論理的な実行順序に従って並べてください
3. orderは1から始まる連番を設定してください
4. 各サブタスクは具体的で実行可能なアクションにしてください
5. 必ずJSON形式で出力してください
"""
```

#### エラーハンドリング:
- サブタスク数の検証（3個未満の場合はエラー）
- サブタスク数の制限（5個を超える場合は切り捨て）
- JSON解析エラーのハンドリング
- Azure OpenAI APIエラーのハンドリング

### 2. APIエンドポイント
**エンドポイント**: `POST /api/tasks/decompose`

#### リクエストスキーマ:
```json
{
  "task_title": "プロジェクト提案資料を作成する",
  "task_description": "新規プロジェクトの提案資料を作成し、経営陣に提出する",
  "parent_due_date": "2025-02-15"
}
```

#### レスポンススキーマ:
```json
{
  "parent_task": "プロジェクト提案資料を作成する",
  "subtasks": [
    {
      "title": "プロジェクトの目的と概要を定義する",
      "description": "新規プロジェクトの目的、目標、概要を明確にし、提案資料の基盤を構築する",
      "order": 1
    },
    {
      "title": "市場調査と競合分析を実施する",
      "description": "プロジェクトの対象市場を調査し、競合他社の分析を行い、提案資料に必要なデータを収集する",
      "order": 2
    },
    ...
  ]
}
```

### 3. テストの実装

#### 単体テスト (`test_task_decomposition.py`):
- 基本的なタスク分解のテスト
- 説明なしのタスク分解のテスト
- エッジケースのテスト（短いタスク名、長い説明）
- サブタスク数の検証（3-5個）
- 順序の検証（1から始まる連番）
- タイトルの存在確認

#### API統合テスト (`test_task_decomposition_api.py`):
- APIエンドポイントの動作確認
- バリデーションエラーのテスト
- レスポンススキーマの検証
- エラーケースのテスト（必須フィールド欠落、不正な日付形式）

## テスト結果

### 単体テスト結果:
```
✓ テストケース 1: プロジェクト提案資料を作成する
  - サブタスク数: 5個 ✓
  - 順序: 1-5 ✓
  - すべてのサブタスクにタイトルあり ✓

✓ テストケース 2: システムの調査を実施する
  - サブタスク数: 4個 ✓
  - 順序: 1-4 ✓
  - すべてのサブタスクにタイトルあり ✓

✓ テストケース 3: 新機能の開発
  - サブタスク数: 5個 ✓
  - 順序: 1-5 ✓
  - すべてのサブタスクにタイトルあり ✓

✓ エッジケース: 短いタスク名 - 成功
✓ エッジケース: 長いタスク説明 - 成功
```

### API統合テスト結果:
```
✓ 基本的なタスク分解 - ステータスコード: 200
✓ 説明なしのタスク分解 - ステータスコード: 200
✓ 短いタスク名 - ステータスコード: 200
✓ 必須フィールド欠落エラー - ステータスコード: 422
✓ 不正な日付形式エラー - ステータスコード: 422
✓ レスポンススキーマ検証 - すべてのフィールド存在
```

## 要件との対応

### Requirements 5.1: サブタスク数の制約
✅ **実装済み**: 3-5個のサブタスクを生成
- プロンプトで3-5個の範囲を指定
- 3個未満の場合はエラーを返す
- 5個を超える場合は最初の5個に制限

### Requirements 5.2: サブタスクの順序
✅ **実装済み**: 論理的な実行順序
- Azure OpenAIが論理的な順序でサブタスクを生成
- orderフィールドに1から始まる連番を設定
- enumerate()を使用して順序を保証

### Requirements 5.3: サブタスクの期限設定
⚠️ **部分実装**: 期限の設定ロジックは未実装
- 現在のレスポンスにはdue_dateフィールドが含まれていない
- SubTaskItemモデルにdue_dateフィールドを追加する必要がある
- 親タスクの期限以前に分散して設定するロジックが必要
- **注**: これはTask 5.5（タスク登録API）で実装予定

## 技術的な詳細

### Azure OpenAI設定:
- モデル: `gpt-4o`
- Temperature: `0.3` (一貫性のある出力のため)
- Max Tokens: `2000`
- Response Format: `json_object` (構造化された出力)

### エラーハンドリング:
1. **JSONDecodeError**: AI応答の形式が不正な場合
2. **HTTPException**: サブタスク数が不足している場合
3. **一般的なException**: その他の予期しないエラー

### ログ出力:
- タスク分解開始時のログ
- OpenAI応答のログ
- 生成されたサブタスク数のログ
- エラー発生時の詳細ログ

## 今後の改善点

### 1. サブタスクの期限設定 (Requirements 5.3)
現在、サブタスクに期限が設定されていません。以下の実装が必要です:
```python
# 親タスクの期限を基に、サブタスクの期限を分散して設定
def distribute_due_dates(parent_due_date: date, subtask_count: int) -> List[date]:
    # 親タスクの期限までの日数を計算
    # サブタスク数で均等に分割
    # 各サブタスクに期限を設定
    pass
```

### 2. リトライ処理
Azure OpenAI APIのエラー時に、指数バックオフでリトライする機能を追加:
```python
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=1, max=10)
)
async def decompose_task_with_retry(...):
    pass
```

### 3. プロンプトの最適化
- より具体的なサブタスクを生成するためのプロンプト改善
- ドメイン固有の知識を活用したプロンプト設計
- Few-shot learningの導入

### 4. キャッシング
- 同じタスクの分解結果をキャッシュして、API呼び出しを削減
- Redis等を使用したキャッシュ機構の実装

## 関連ファイル

### 実装ファイル:
- `app/services/task_service.py` - タスク分解ロジック
- `app/routers/tasks.py` - APIエンドポイント
- `app/models/task.py` - データモデル

### テストファイル:
- `test_task_decomposition.py` - 単体テスト
- `test_task_decomposition_api.py` - API統合テスト

### ドキュメント:
- `TASK_5.3_IMPLEMENTATION_SUMMARY.md` - 本ドキュメント

## 結論

Task 5.3「タスク分解API」の実装が完了しました。Azure OpenAIとの連携により、抽象的なタスクを3-5個の具体的なサブタスクに分解する機能が正常に動作しています。

すべてのテストが成功し、要件5.1と5.2を満たしています。要件5.3（サブタスクの期限設定）については、Task 5.5（タスク登録API）で実装予定です。

次のステップは、Task 5.4（タスク分解のプロパティテスト）またはTask 5.5（タスクDB登録API）の実装です。
