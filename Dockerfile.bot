FROM --platform=linux/arm64 ubuntu:22.04

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
ENV DEBIAN_FRONTEND=noninteractive
ENV LD_LIBRARY_PATH=/app/sdk

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    # ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«
    build-essential \
    cmake \
    g++ \
    libcurl4-openssl-dev \
    # ãƒ‡ãƒãƒƒã‚°ãƒ»é–‹ç™ºãƒ„ãƒ¼ãƒ«
    curl \
    git \
    gdb \
    # GUI/ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹é–¢é€£ï¼ˆZoom SDKãŒå¿…è¦ã¨ã™ã‚‹ï¼‰
    libglib2.0-0 \
    libgstreamer-plugins-base1.0-0 \
    libxcb-keysyms1 \
    libxcb-shm0 \
    libxcb-xfixes0 \
    libxcb-shape0 \
    libxcb-randr0 \
    libxcb-image0 \
    libfontconfig1 \
    libxi6 \
    libsm6 \
    libxrender1 \
    libxkbcommon0 \
    libxkbcommon-x11-0 \
    # ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªé–¢é€£
    libpulse0 \
    libasound2 \
    libasound2-plugins \
    pulseaudio \
    pulseaudio-utils \
    # ãã®ä»–
    ca-certificates \
    pkg-config \
    libdbus-1-3 \
    libgbm1 \
    # Pythonï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆç”¨ï¼‰
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# è¿½åŠ ã®ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆãƒªãƒ³ã‚¯ã‚¨ãƒ©ãƒ¼è§£æ¶ˆç”¨ï¼‰
RUN apt-get update && apt-get install -y \
    libgl1-mesa-dev \
    libxfixes-dev \
    libxcb-xtest0-dev \
    libx11-dev \
    libxcb1-dev \
    libgbm-dev \
    xvfb \
    qtbase5-dev \
    && rm -rf /var/lib/apt/lists/*

ENV LD_LIBRARY_PATH=/app/sdk:/app/sdk/qt_libs/Qt/lib:$LD_LIBRARY_PATH

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š
WORKDIR /app

# ----- SDKã®ã‚³ãƒ”ãƒ¼ (ARM64ç‰ˆ) -----
COPY zoom-meeting-sdk-linux_arm64-6.7.2.7022 /app/sdk
RUN ln -s /app/sdk/libmeetingsdk.so /app/sdk/libmeetingsdk.so.1

# ----- C++ Bot ãƒ“ãƒ«ãƒ‰ -----
COPY app/zoom_bot /app/zoom_bot_src

# CMakeãƒ“ãƒ«ãƒ‰
RUN mkdir -p /app/zoom_bot_src/build && \
    cd /app/zoom_bot_src/build && \
    cmake -DZOOM_SDK_DIR=/app/sdk .. && \
    make -j$(nproc) && \
    cp ZoomMeetingBot /app/zoom_bot

# ----- Pythonãƒ©ãƒƒãƒ‘ãƒ¼ -----
COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt

COPY app /app/app

# PulseAudioè¨­å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆ
COPY app/bot_runner/setup-pulseaudio.sh /app/setup-pulseaudio.sh
RUN chmod +x /app/setup-pulseaudio.sh

# éŸ³å£°ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
COPY app/bot_runner/audio_capture.sh /app/audio_capture.sh
RUN chmod +x /app/audio_capture.sh

# ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
COPY app/bot_runner/upload_workflow.py /app/upload_workflow.py

# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
COPY app/bot_runner/realtime_transcriber.py /app/realtime_transcriber.py

# Pythonã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
COPY app/bot_runner/entrypoint.py /app/entrypoint.py

# config_generator.py (entrypoint.pyã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã‚‹)
COPY app/bot_runner/config_generator.py /app/config_generator.py

# éŒ²éŸ³ä¿å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
RUN mkdir -p /app/recordings

# ----- ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ -----
COPY <<'EOF' /app/entrypoint.sh
#!/bin/bash
set -e

echo "=========================================="
echo "  ğŸ¤– Tech Notta - Zoom Meeting Bot"
echo "  ğŸ“ Real-time + Broadcast Mode"
echo "=========================================="

# Xvfbèµ·å‹•
echo "[Entrypoint] Xvfbèµ·å‹•ä¸­..."
Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
export DISPLAY=:99
sleep 1

# ãƒ¡ã‚¤ãƒ³ã®Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
# (PulseAudioè¨­å®šã€éŸ³å£°ã‚­ãƒ£ãƒ—ãƒãƒ£ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã—ã€Botå®Ÿè¡Œã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ã¦ã‚’ç®¡ç†)
echo "[Entrypoint] Pythonã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè¡Œ..."
exec python3 /app/entrypoint.py "$@"
EOF

RUN chmod +x /app/entrypoint.sh

# éŒ²éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ç”¨ãƒœãƒªãƒ¥ãƒ¼ãƒ 
VOLUME ["/app/recordings"]

ENTRYPOINT ["/app/entrypoint.sh"]

